---
title: "use"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{use}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# `ormr`

`ormr` allows to work with Python installed to a custom location,
using only a single point of contact.

```{r setup}
library(ormr)
```

We use only one point of contact, `ormr_folder_name`,
which is the folder where `ormr` installs the Python environment and packages
needed:

```{r}
ormr_folder_name <- tempfile(pattern = "ormr_")
ormr_folder_name
```

# Goal

The goal of this vignette is to show how to use `ormr` 
to run an example Python script, 
where Python is installed to a custom location.

Here is the example Python script we want to run:

```{r}
python_script_path <- system.file("extdata", "scipy_example.py", package = "ormr")
readLines(python_script_path)
```

As a spoiler, it is demonstrated here that the script cannot be run yet:

```{r}
testthat::expect_error(
  ormr::run_python_script(
    ormr_folder_name = ormr_folder_name,
    python_script_path = python_script_path
  ),
  "failed to discover Python binary associated with path"
)
```

# Overview

These are the steps to achieve the goal:

 1. Create a Conda environment
 2. Install Python packages within that Conda environment
 3. Run a Python script with that Conda environment and packages

## 1. Create a Conda environment

Initially, the Conda environment does not exist:

```{r}
testthat::expect_false(
  ormr::does_conda_env_exists(ormr_folder_name = ormr_folder_name)
)
```

Create the Conda environment:

```{r}
ormr::create_conda_env(ormr_folder_name = ormr_folder_name)
```

Indeed, now the Conda environment exists:

```{r}
testthat::expect_true(
  ormr::does_conda_env_exists(ormr_folder_name = ormr_folder_name)
)
```


## 2. Install Python packages within that Conda environment

Currently, these packages are installed:

```{r}
installed_python_packages <- ormr::get_installed_python_packages(ormr_folder_name = ormr_folder_name)
knitr::kable(installed_python_packages)
```

We are going to install `scipy`, which is a small package:

```{r}
package_name <- "scipy"
```

We can verify that it is not installed yet:

```{r}
testthat::expect_false(
  ormr::is_python_package_installed(
    ormr_folder_name = ormr_folder_name,
    package_name = package_name
  )
)
```

Also, running an Python script that requires `scipy` fails now:

```{r}
testthat::expect_error(
  ormr::run_python_script(
    ormr_folder_name = ormr_folder_name,
    python_script_path = python_script_path
  ),
  "ModuleNotFoundError: No module named 'scipy'"
)
```

Here, we install the package:

```{r}
ormr::install_python_packages(
  ormr_folder_name = ormr_folder_name,
  package_names = package_name
)
```

Now the Python package is installed:

```{r}
testthat::expect_true(
  ormr::is_python_package_installed(
    ormr_folder_name = ormr_folder_name,
    package_name = package_name
  )
)
```

## 3. Run a Python script with that Conda environment and packages

Great, with our environment and packages in place,
we run a Python script with those packages:

```{r}
testthat::expect_silent(
  ormr::run_python_script(
    ormr_folder_name = ormr_folder_name,
    python_script_path = python_script_path
  )
)
```

No error, so we can conclude it works!

# Cleaning up

The clean up, we throw away the `ormr` folder in which the magic happened.

```{r}
unlink(ormr_folder_name, recursive = TRUE)
```
